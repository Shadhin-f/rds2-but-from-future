<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5572277246422121"
      crossorigin="anonymous"
    ></script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-DR0D2D6C35"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-DR0D2D6C35");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/index.png" />
    <title>Routine Maker</title>
    <link rel="stylesheet" href="styles.css?v=1.1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .trending-link {
        box-shadow: 0 0 8px 2px #e11d48, 0 0 16px 4px #be185d;
        border-color: #e11d48 !important;
        color: #fff !important;
        position: relative;
        z-index: 2;
      }
      .trending-link:hover {
        box-shadow: 0 0 16px 4px #e11d48, 0 0 24px 8px #be185d;
        background: linear-gradient(135deg, #e11d48, #be185d) !important;
        color: #fff !important;
      }

      .routine-page-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 20px;
        margin-top: 1.5rem;
        align-items: start;
      }

      .routine-sidebar {
        background: var(--surface-color);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .routine-main {
        background: var(--surface-color);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 1.05rem;
        font-weight: 700;
        margin-bottom: 14px;
        color: var(--text-color);
        padding-bottom: 8px;
        border-bottom: 2px solid var(--primary-color);
      }

      .manual-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .form-group.full {
        grid-column: 1 / -1;
      }

      .form-group label {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        outline: none;
        width: 100%;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.15);
      }

      .form-group input::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
      }

      .day-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
      }

      .day-checkboxes label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
        color: var(--text-color);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        transition: all 0.2s;
      }

      .day-checkboxes label:hover {
        border-color: var(--primary-color);
      }

      .day-checkboxes label:has(input:checked) {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: #fff;
      }

      .day-checkboxes input[type="checkbox"] {
        width: 14px;
        height: 14px;
        accent-color: var(--primary-color);
      }

      .quick-days {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
      }

      .quick-day-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quick-day-btn:hover {
        border-color: var(--primary-color);
        background: rgba(109, 40, 217, 0.1);
      }

      .quick-day-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: #fff;
      }

      .btn-submit {
        padding: 12px 16px;
        border-radius: 8px;
        border: none;
        background: var(--primary-gradient);
        color: #fff;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn-submit:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3);
      }

      .btn-submit:active {
        transform: translateY(0);
      }

      .search-panel {
        margin-bottom: 16px;
      }

      .search-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .search-row select,
      .search-row input {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
        flex: 1;
        min-height: 42px;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .search-row select:focus,
      .search-row input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.15);
      }

      .search-row select {
        min-width: 140px;
        flex: 0 0 auto;
        cursor: pointer;
      }

      .search-row input::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
      }

      .search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-color);
      }

      .search-result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .search-result-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .result-info {
        flex: 1;
      }

      .result-course {
        font-weight: 600;
        color: var(--text-color);
      }

      .result-meta {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .btn-add {
        padding: 4px 12px;
        border-radius: 20px;
        border: none;
        background: var(--primary-gradient);
        color: #fff;
        font-size: 0.78rem;
        cursor: pointer;
      }

      .btn-add:disabled {
        background: var(--border-color);
        color: var(--text-muted);
        cursor: default;
      }

      .routine-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .routine-actions {
        display: flex;
        gap: 8px;
      }

      .btn-action {
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-action.primary {
        background: var(--primary-gradient);
        border: none;
      }

      .btn-action:hover {
        opacity: 0.9;
      }

      .routine-table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .planner-table {
        width: 100%;
        min-width: 600px;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .planner-table th,
      .planner-table td {
        border: 1px solid var(--border-color);
        padding: 8px 6px;
        text-align: center;
        vertical-align: top;
        min-width: 70px;
      }

      .planner-table th {
        background: var(--primary-color);
        color: #fff;
        font-weight: 600;
        font-size: 0.85rem;
        border-bottom: 2px solid var(--primary-color);
      }

      .planner-table td:first-child {
        font-weight: 600;
        background: var(--border-color);
        white-space: nowrap;
        font-size: 0.8rem;
      }

      .course-block {
        display: inline-flex;
        flex-direction: column;
        background: var(--border-color);
        color: #fff;
        border-radius: 8px;
        padding: 6px 10px;
        margin: 3px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        max-width: 130px;
        position: relative;
        text-align: left;
      }

      .course-block .course-name {
        font-weight: 700;
        font-size: 0.82rem;
        margin-bottom: 2px;
      }

      .course-block .faculty {
        display: block;
        font-size: 0.72rem;
        font-weight: 400;
        opacity: 0.9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .course-block .room {
        display: block;
        font-size: 0.7rem;
        font-weight: 500;
        opacity: 0.85;
        margin-top: 2px;
        background: rgba(255, 255, 255, 0.15);
        padding: 1px 4px;
        border-radius: 3px;
        width: fit-content;
      }

      .course-block .remove-btn {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background: rgba(0, 0, 0, 0.2);
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 0.75rem;
        padding: 2px 5px;
        border-radius: 50%;
        line-height: 1;
        transition: background 0.2s;
      }

      .course-block .remove-btn:hover {
        background: #ef4444;
        color: #fff;
      }

      .routine-summary {
        margin-top: 12px;
        font-size: 0.85rem;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }

      .empty-routine {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
      }

      @media (max-width: 900px) {
        .routine-page-layout {
          grid-template-columns: 1fr;
        }
        .routine-sidebar {
          order: 2;
        }
        .routine-main {
          order: 1;
        }
      }

      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
        .search-row {
          flex-direction: column;
        }
        .routine-header {
          flex-direction: column;
          align-items: stretch;
        }
        .routine-actions {
          justify-content: stretch;
        }
        .btn-action {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="particleCanvas"></canvas>
    <div class="container">
      <header>
        <h1>Routine Maker</h1>
        <nav class="nav-bar">
          <a href="index.html">RDS2</a>
          <a href="calendar.html">Academic Calendar</a>
          <a href="resources.html" class="trending-link">Study Materials</a>
          <a href="routine.html" class="active">Routine Maker</a>
          <a href="planner.html">Semester Planner</a>
          <a href="freshman.html">Freshman Guides</a>
          <a href="coursemap.html">Course map</a>
          <a href="booksearch.html">NSU Library Book Locator</a>
          <a href="shelf_search.html">Library Shelf Finder</a>
          <a href="cgpa.html">CGPA Calculator</a>
          <a href="retake.html">Retake Calculator ðŸ”¥</a>
          <a href="gradeCalculator.html">Course Grade Calculator</a>
          <a href="about.html">Dev</a>
        </nav>
      </header>

      <main>
        <div class="announcement-bar">
          <span>ðŸŽ“ Join telegram group to stay updated</span>
          <a
            href="https://t.me/nsu_advising_helper_bot_channel"
            target="_blank"
            class="view-extension-btn"
            >âš¡ Join now</a
          >
        </div>
        <div class="announcement-bar">
          <span
            >Routine maker is still under Development, use it in the
            laptop/desktop for better experience</span
          >
        </div>
        <div class="routine-page-layout">
          <!-- Sidebar: Manual Add -->
          <aside class="routine-sidebar">
            <div class="section-title">Add Course Manually</div>
            <form id="manualForm" class="manual-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Course Code*</label>
                  <input
                    type="text"
                    id="manualCode"
                    required
                    placeholder="CSE115"
                  />
                </div>
                <div class="form-group">
                  <label>Section</label>
                  <input type="text" id="manualSection" placeholder="1" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Faculty</label>
                  <input type="text" id="manualFaculty" placeholder="TBA" />
                </div>
                <div class="form-group">
                  <label>Room</label>
                  <input type="text" id="manualRoom" placeholder="NAC401" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Start Time*</label>
                  <input type="time" id="manualStart" required />
                </div>
                <div class="form-group">
                  <label>End Time*</label>
                  <input type="time" id="manualEnd" required />
                </div>
              </div>
              <div class="form-group full">
                <label>Days*</label>
                <div class="quick-days">
                  <button
                    type="button"
                    class="quick-day-btn"
                    data-days="Sun,Tue"
                  >
                    ST
                  </button>
                  <button
                    type="button"
                    class="quick-day-btn"
                    data-days="Sat,Thu"
                  >
                    RA
                  </button>
                  <button
                    type="button"
                    class="quick-day-btn"
                    data-days="Mon,Wed"
                  >
                    MW
                  </button>
                </div>
                <div class="day-checkboxes">
                  <label
                    ><input type="checkbox" value="Sat" class="day-cb" />
                    Sat</label
                  >
                  <label
                    ><input type="checkbox" value="Sun" class="day-cb" />
                    Sun</label
                  >
                  <label
                    ><input type="checkbox" value="Mon" class="day-cb" />
                    Mon</label
                  >
                  <label
                    ><input type="checkbox" value="Tue" class="day-cb" />
                    Tue</label
                  >
                  <label
                    ><input type="checkbox" value="Wed" class="day-cb" />
                    Wed</label
                  >
                  <label
                    ><input type="checkbox" value="Thu" class="day-cb" />
                    Thu</label
                  >
                  <label
                    ><input type="checkbox" value="Fri" class="day-cb" />
                    Fri</label
                  >
                </div>
              </div>
              <button type="submit" class="btn-submit">Add to Routine</button>
            </form>
          </aside>

          <!-- Main: Search + Routine Table -->
          <section class="routine-main">
            <div class="search-panel">
              <div class="section-title">Search & Add from Course List</div>
              <div class="search-row">
                <select id="semesterSelect">
                  <option value="summer25.csv" disabled>Summer 2025</option>
                  <option value="fall2025.csv" disabled>Fall 2025</option>
                  <option value="261_v3.csv" selected>Spring 2026</option>
                </select>
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search course, faculty, section..."
                />
              </div>
              <div id="searchResults" class="search-results"></div>
            </div>

            <div class="routine-header">
              <div class="section-title" style="margin-bottom: 0">
                Your Routine
              </div>
              <div class="routine-actions">
                <button id="clearBtn" class="btn-action">
                  <i class="fas fa-trash"></i> Clear
                </button>
                <button id="downloadBtn" class="btn-action primary">
                  <i class="fas fa-download"></i> Download
                </button>
              </div>
            </div>

            <div class="routine-table-wrapper">
              <table class="planner-table" id="routineTable">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Sat</th>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                  </tr>
                </thead>
                <tbody id="routineBody"></tbody>
              </table>
            </div>

            <div class="routine-summary">
              <span id="summaryText">No courses added yet.</span>
              <span id="conflictText"></span>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      // ==================== LOCAL UTILITY FUNCTIONS ====================
      function parseCSV(csv) {
        const lines = csv.split("\n").filter((l) => l.trim());
        if (lines.length < 2) return [];
        const headers = lines[0].split(",").map((h) => h.trim());
        return lines.slice(1).map((line) => {
          const values = [];
          let current = "";
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === "," && !inQuotes) {
              values.push(current.trim());
              current = "";
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          const obj = {};
          headers.forEach((h, i) => (obj[h] = values[i] || ""));
          return obj;
        });
      }

      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // ==================== PLANNER ROUTINE ====================
      const PLANNER_KEY = "planner_routine_courses";
      const PLANNER_DAYS = ["Sat", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri"];
      const dayMap = {
        A: "Sat",
        S: "Sun",
        M: "Mon",
        T: "Tue",
        W: "Wed",
        R: "Thu",
        F: "Fri",
      };

      let plannerCourses = [];

      function loadPlannerCourses() {
        try {
          plannerCourses = JSON.parse(localStorage.getItem(PLANNER_KEY)) || [];
        } catch {
          plannerCourses = [];
        }
      }

      function savePlannerCourses() {
        localStorage.setItem(PLANNER_KEY, JSON.stringify(plannerCourses));
      }

      // Convert "HH:MM" 24h to minutes
      function toMinutes(timeStr) {
        const [h, m] = timeStr.split(":").map(Number);
        return h * 60 + m;
      }

      // Convert minutes to "HH:MM AM/PM"
      function formatTime(mins) {
        let h = Math.floor(mins / 60);
        let m = mins % 60;
        const ampm = h >= 12 ? "PM" : "AM";
        if (h === 0) h = 12;
        else if (h > 12) h -= 12;
        return `${h}:${String(m).padStart(2, "0")} ${ampm}`;
      }

      // Parse CSV time format "11:20 AM - 12:50 PM RA"
      function parseCsvTime(timeStr) {
        const match = timeStr.match(
          /^(\d{1,2}:\d{2} [AP]M)\s*-\s*(\d{1,2}:\d{2} [AP]M)\s*([A-Z]+)$/i
        );
        if (!match) return null;
        const [, startStr, endStr, daysCode] = match;

        const parse12h = (t) => {
          const [time, ampm] = t.split(" ");
          let [h, m] = time.split(":").map(Number);
          if (ampm === "PM" && h !== 12) h += 12;
          if (ampm === "AM" && h === 12) h = 0;
          return h * 60 + m;
        };

        const days = daysCode
          .split("")
          .map((d) => dayMap[d])
          .filter(Boolean);
        return {
          startMin: parse12h(startStr),
          endMin: parse12h(endStr),
          days,
        };
      }

      // Check if course already in planner
      function isInPlanner(code, section) {
        return plannerCourses.some(
          (c) => c.code === code && c.section === section
        );
      }

      // Add course to planner
      function addToPlanner(course) {
        if (isInPlanner(course.code, course.section)) return;
        plannerCourses.push(course);
        savePlannerCourses();
        renderRoutineTable();
        updateSummary();
        refreshSearchResults();
      }

      // Remove course from planner
      function removeFromPlanner(idx) {
        plannerCourses.splice(idx, 1);
        savePlannerCourses();
        renderRoutineTable();
        updateSummary();
        refreshSearchResults();
      }

      // ==================== RENDER ROUTINE TABLE (same logic as Quick Routine) ====================
      function renderRoutineTable() {
        const tbody = document.getElementById("routineBody");
        tbody.innerHTML = "";

        if (plannerCourses.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="8" class="empty-routine">No courses added. Use the form or search to add courses.</td>`;
          tbody.appendChild(tr);
          return;
        }

        // Collect all unique time points
        let timePoints = [];
        plannerCourses.forEach((c) => {
          timePoints.push(c.startMin, c.endMin);
        });
        timePoints = [...new Set(timePoints)].sort((a, b) => a - b);

        // Build time slots, skip small empty gaps
        const timeSlots = [];
        for (let i = 0; i < timePoints.length - 1; i++) {
          const slotStart = timePoints[i];
          const slotEnd = timePoints[i + 1];
          const duration = slotEnd - slotStart;

          const hasAnyCourse = plannerCourses.some(
            (c) => c.startMin < slotEnd && c.endMin > slotStart
          );

          if (duration <= 10 && !hasAnyCourse) continue;
          timeSlots.push([slotStart, slotEnd]);
        }

        // Render each time slot row
        timeSlots.forEach(([slotStart, slotEnd]) => {
          const tr = document.createElement("tr");

          // Time cell
          const timeCell = document.createElement("td");
          timeCell.textContent = `${formatTime(slotStart)} - ${formatTime(
            slotEnd
          )}`;
          tr.appendChild(timeCell);

          // Day cells
          PLANNER_DAYS.forEach((day) => {
            const td = document.createElement("td");

            const coursesInSlot = plannerCourses
              .map((c, idx) => ({ ...c, _idx: idx }))
              .filter(
                (c) =>
                  c.days.includes(day) &&
                  c.startMin <= slotStart &&
                  c.endMin > slotStart
              );

            if (coursesInSlot.length > 0) {
              td.innerHTML = coursesInSlot
                .map(
                  (c) => `
                  <span class="course-block" title="${c.code} Sec-${
                    c.section || "N/A"
                  } (${c.faculty || "TBA"})${c.room ? " | " + c.room : ""}">
                    <span class="course-name">${c.code}${
                    c.section ? " - " + c.section : ""
                  }</span>
                    ${
                      c.faculty
                        ? `<span class="faculty">${c.faculty}</span>`
                        : ""
                    }
                    ${c.room ? `<span class="room">${c.room}</span>` : ""}
                    <button class="remove-btn" data-idx="${
                      c._idx
                    }" title="Remove">âœ•</button>
                  </span>
                `
                )
                .join("");
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        // Attach remove handlers
        document.querySelectorAll(".remove-btn").forEach((btn) => {
          btn.onclick = () => removeFromPlanner(Number(btn.dataset.idx));
        });
      }

      // ==================== SUMMARY & CONFLICTS ====================
      function updateSummary() {
        const summaryEl = document.getElementById("summaryText");
        const conflictEl = document.getElementById("conflictText");

        if (!plannerCourses.length) {
          summaryEl.textContent = "No courses added yet.";
          conflictEl.textContent = "";
          return;
        }

        summaryEl.textContent = `${plannerCourses.length} course${
          plannerCourses.length > 1 ? "s" : ""
        } in routine.`;

        // Check conflicts
        let conflicts = 0;
        PLANNER_DAYS.forEach((day) => {
          const dayCourses = plannerCourses.filter((c) => c.days.includes(day));
          for (let i = 0; i < dayCourses.length; i++) {
            for (let j = i + 1; j < dayCourses.length; j++) {
              const a = dayCourses[i];
              const b = dayCourses[j];
              if (a.startMin < b.endMin && b.startMin < a.endMin) {
                conflicts++;
              }
            }
          }
        });

        conflictEl.textContent = conflicts
          ? `âš ï¸ ${conflicts} time conflict${conflicts > 1 ? "s" : ""}`
          : "âœ“ No conflicts";
        conflictEl.style.color = conflicts ? "#f87171" : "#4ade80";
      }

      // ==================== SEARCH & ADD FROM CSV ====================
      let searchData = [];

      async function loadSearchData() {
        const semester = document.getElementById("semesterSelect").value;
        const container = document.getElementById("searchResults");
        container.innerHTML = `<div style="padding:12px;text-align:center;color:var(--text-muted);">Loading courses...</div>`;

        try {
          const res = await fetch(semester);
          if (!res.ok) throw new Error("Failed to fetch");
          const csv = await res.text();
          searchData = parseCSV(csv);
          console.log("Loaded", searchData.length, "courses");
        } catch (err) {
          console.error("Error loading CSV:", err);
          searchData = [];
          container.innerHTML = `<div style="padding:12px;text-align:center;color:#f87171;">Failed to load course data.</div>`;
          return;
        }
        refreshSearchResults();
      }

      function refreshSearchResults() {
        const container = document.getElementById("searchResults");
        const term = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();

        if (!searchData.length) {
          container.innerHTML = `<div style="padding:12px;text-align:center;color:var(--text-muted);">No course data loaded.</div>`;
          return;
        }

        const filtered = searchData.filter((c) => {
          if (!term) return true;
          const course = (c.Course || "").toLowerCase();
          const faculty = (c.Faculty || "").toLowerCase();
          const section = (c.Section || "").toLowerCase();
          return (
            course.includes(term) ||
            faculty.includes(term) ||
            section.includes(term)
          );
        });

        // Show max 30 results (or first 20 if no search term)
        const maxResults = term ? 100 : 20;

        if (!filtered.length) {
          container.innerHTML = `<div style="padding:12px;text-align:center;color:var(--text-muted);">No courses found for "${term}".</div>`;
          return;
        }

        container.innerHTML = filtered
          .slice(0, maxResults)
          .map((c) => {
            const inPlanner = isInPlanner(c.Course, c.Section);
            const courseData = JSON.stringify(c)
              .replace(/'/g, "&#39;")
              .replace(/"/g, "&quot;");
            return `
            <div class="search-result-item">
              <div class="result-info">
                <div class="result-course">${c.Course || "N/A"} - Sec ${
              c.Section || "?"
            }</div>
                <div class="result-meta">${c.Faculty || "TBA"} | ${
              c.Time || "N/A"
            } | ${c.Room || ""}</div>
              </div>
              <button class="btn-add" data-course="${courseData}" ${
              inPlanner ? "disabled" : ""
            }>
                ${inPlanner ? "Added" : "Add"}
              </button>
            </div>
          `;
          })
          .join("");

        if (filtered.length > maxResults) {
          container.innerHTML += `<div style="padding:8px;text-align:center;color:var(--text-muted);font-size:0.8rem;">Showing ${maxResults} of ${filtered.length} results. Type to narrow down.</div>`;
        }

        // Attach add handlers
        container
          .querySelectorAll(".btn-add:not([disabled])")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const courseStr = this.getAttribute("data-course");
              const c = JSON.parse(
                courseStr.replace(/&quot;/g, '"').replace(/&#39;/g, "'")
              );
              const parsed = parseCsvTime(c.Time);
              if (!parsed) {
                alert("Could not parse time for this course: " + c.Time);
                return;
              }

              addToPlanner({
                code: c.Course,
                section: c.Section,
                faculty: c.Faculty,
                room: c.Room,
                startMin: parsed.startMin,
                endMin: parsed.endMin,
                days: parsed.days,
              });
            });
          });
      }

      // ==================== INIT ====================
      function initRoutinePage() {
        // Load saved courses
        loadPlannerCourses();
        renderRoutineTable();
        updateSummary();

        // Quick day selection buttons
        document.querySelectorAll(".quick-day-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const days = this.dataset.days.split(",");

            // Clear all checkboxes first
            document.querySelectorAll(".day-cb").forEach((cb) => {
              cb.checked = false;
            });

            // Check the selected days
            days.forEach((day) => {
              const cb = document.querySelector(`.day-cb[value="${day}"]`);
              if (cb) cb.checked = true;
            });

            // Update button active states
            document.querySelectorAll(".quick-day-btn").forEach((b) => {
              b.classList.remove("active");
            });
            this.classList.add("active");
          });
        });

        // Manual form handler
        const manualForm = document.getElementById("manualForm");
        if (manualForm) {
          manualForm.addEventListener("submit", function (e) {
            e.preventDefault();
            console.log("Manual form submitted");

            const code = document
              .getElementById("manualCode")
              .value.trim()
              .toUpperCase();
            const section = document
              .getElementById("manualSection")
              .value.trim();
            const faculty = document
              .getElementById("manualFaculty")
              .value.trim();
            const room = document.getElementById("manualRoom").value.trim();
            const start = document.getElementById("manualStart").value;
            const end = document.getElementById("manualEnd").value;
            const days = [...document.querySelectorAll(".day-cb:checked")].map(
              (cb) => cb.value
            );

            console.log("Form data:", {
              code,
              section,
              faculty,
              room,
              start,
              end,
              days,
            });

            if (!code || !start || !end || !days.length) {
              alert(
                "Please fill all required fields and select at least one day."
              );
              return;
            }

            const startMin = toMinutes(start);
            const endMin = toMinutes(end);

            if (startMin >= endMin) {
              alert("End time must be after start time.");
              return;
            }

            if (isInPlanner(code, section)) {
              alert("This course is already in your routine.");
              return;
            }

            addToPlanner({
              code,
              section,
              faculty,
              room,
              startMin,
              endMin,
              days,
            });

            manualForm.reset();
          });
        }

        // Clear button
        const clearBtn = document.getElementById("clearBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", function () {
            if (!plannerCourses.length) return;
            if (!confirm("Clear all courses from routine?")) return;
            plannerCourses = [];
            savePlannerCourses();
            renderRoutineTable();
            updateSummary();
            refreshSearchResults();
          });
        }

        // Download button
        const downloadBtn = document.getElementById("downloadBtn");
        if (downloadBtn) {
          downloadBtn.addEventListener("click", async function () {
            const wrapper = document.querySelector(".routine-table-wrapper");
            if (!wrapper) return;

            try {
              const canvas = await html2canvas(wrapper, {
                backgroundColor: "#0f172a",
                scale: 2,
              });
              const link = document.createElement("a");
              link.href = canvas.toDataURL("image/png");
              link.download = "routine.png";
              link.click();
            } catch (err) {
              alert("Failed to download. Try again.");
            }
          });
        }

        // Semester select
        const semesterSelect = document.getElementById("semesterSelect");
        if (semesterSelect) {
          semesterSelect.addEventListener("change", loadSearchData);
        }

        // Search input with debounce
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.addEventListener(
            "input",
            debounce(refreshSearchResults, 300)
          );
        }

        // Load initial search data
        loadSearchData();
      }

      // Run when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initRoutinePage);
      } else {
        initRoutinePage();
      }
    </script>
  </body>
</html>
