<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5572277246422121"
      crossorigin="anonymous"
    ></script>
    <meta name="google-adsense-account" content="ca-pub-5572277246422121" />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-DR0D2D6C35"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-DR0D2D6C35");
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/index.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NSU Library Book Finder</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .search-panel {
        margin: 1.5rem 0 1rem;
      }
      .search-panel label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--text-muted);
      }
      .search-panel input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        padding: 14px 48px 14px 14px;
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-color);
        font-size: 1.05rem;
        transition: all 0.3s ease;
      }
      .search-panel input[type="text"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.2);
      }
      .search-panel .search-icon {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-top: 0.4rem;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }
      #message {
        min-height: 48px;
        margin: 1rem 0;
        display: flex;
        align-items: center;
      }
      .results {
        display: grid;
        gap: 18px;
        margin-bottom: 1rem;
      }
      .result-card {
        background: var(--surface-color);
        border-radius: 14px;
        padding: 18px 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
        overflow: hidden;
      }
      .result-card + .result-card {
        margin-top: 0;
      }
      .result-card h3 {
        margin: 0 0 0.35rem;
        font-size: 1.2rem;
      }
      .result-card h3 a {
        color: var(--text-color);
        text-decoration: none;
      }
      .result-card h3 a:hover {
        color: var(--primary-color);
      }
      .book-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.6rem;
      }
      .call-list {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.5rem;
      }
      .call-chip {
        background: rgba(139, 92, 246, 0.12);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      .call-chip .subjects {
        margin-top: 0.2rem;
        font-size: 0.85rem;
      }
      .call-chip strong {
        font-family: "Courier New", monospace;
        letter-spacing: 0.04em;
      }
      .call-chip-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }
      .location-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--border-color);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.85rem;
      }
      .subjects {
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .info-text {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-top: 0;
        margin-bottom: 1rem;
        line-height: 1.5;
      }
      .results-summary {
        margin-top: 0.25rem;
        margin-bottom: 1.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .no-results {
        text-align: center;
        color: var(--text-muted);
        font-size: 1rem;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .status-pill.loading {
        background: rgba(99, 102, 241, 0.12);
        border: 1px solid rgba(99, 102, 241, 0.35);
        color: var(--primary-color);
      }
      .status-pill.error {
        background: rgba(248, 113, 113, 0.15);
        border: 1px solid rgba(248, 113, 113, 0.35);
        color: #f87171;
      }
      .status-pill.success {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.35);
        color: #34d399;
      }
    </style>
  </head>
  <body>
    <canvas id="particleCanvas"></canvas>
    <div class="container">
      <header>
        <h1>Where is my book?</h1>
        <nav class="nav-bar">
          <a href="index.html">RDS2</a>
          <a href="calendar.html">Academic Calendar</a>
          <a href="resources.html" class="trending-link">Study Materials</a>
          <a href="routine.html">Routine Maker</a>
          <a href="planner.html">Semester Planner</a>
          <a href="freshman.html">Freshman Guides</a>
          <a href="coursemap.html">Course map</a>
          <a href="booksearch.html" class="active">NSU Library Book Locator</a>
          <a href="shelf_search.html">Shelf Finder</a>
        </nav>
      </header>

      <div class="announcement-bar">
        <span
          >Easily Search and locate books from the NSU Library</span
        >
      </div>

      <div class="search-panel">
        <label for="bookQuery">Search by book title or author</label>
        <input
          type="text"
          id="bookQuery"
          placeholder="e.g., Game Theory, Kieso, Marketing"
          autocomplete="off"
        />
        <!-- <div class="search-icon">
          <i class="fas fa-circle-notch"></i>
          Results update automatically as you type. We search titles and
          authors from the NSU catalog dump.
        </div> -->
      </div>
      <p class="info-text">
        Tip: Copy the exact spelling from the NSU OPAC for best matches. We
        show shelf directions for every call number we can map.
      </p>

      <div id="message"></div>
      <div id="results" class="results"></div>
      <div id="resultsSummary" class="results-summary"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
      const MAX_RESULTS = 25;
      const DEBOUNCE_MS = 280;

      const state = {
        shelves: [],
        books: [],
        shelvesLoading: false,
        booksLoading: false,
        shelvesError: null,
        booksError: null,
      };

      const els = {
        message: document.getElementById("message"),
        results: document.getElementById("results"),
        summary: document.getElementById("resultsSummary"),
        search: document.getElementById("bookQuery"),
      };

      let debounceTimer = null;

      function updateStatus() {
        if (state.shelvesError || state.booksError) {
          const text = [state.shelvesError, state.booksError]
            .filter(Boolean)
            .join(" · ");
          els.message.innerHTML = `
            <div class="status-pill error">
              <i class="fas fa-triangle-exclamation"></i> ${text}
            </div>`;
          return;
        }

        if (state.shelvesLoading || state.booksLoading) {
          const waitingFor = [];
          if (state.booksLoading) waitingFor.push("books");
          if (state.shelvesLoading) waitingFor.push("shelf map");
          els.message.innerHTML = `
            <div class="status-pill loading">
              <i class="fas fa-spinner fa-spin"></i>
              Loading ${waitingFor.join(" & ")} data...
            </div>`;
          return;
        }

        els.message.innerHTML = `
          <div class="status-pill success">
            <i class="fas fa-circle-check"></i>
            Loaded ${state.books.length.toLocaleString()} books · ${state.shelves.length} shelf rows
          </div>`;
      }

      function normalizeCallNumber(callNum) {
        if (!callNum) return "";
        return callNum
          .toString()
          .toUpperCase()
          .replace(/\s+/g, "")
          .replace(/[,:;.]+$/, "")
          .trim();
      }

      function parseCallNumber(callNum) {
        if (!callNum) return null;
        const s = normalizeCallNumber(callNum);
        const match = s.match(/^([A-Z]+)(\d+(?:\.\d+)?)?/);
        if (!match) return null;
        return {
          letters: match[1],
          number: match[2] !== undefined ? parseFloat(match[2]) : null,
          original: s,
        };
      }

      function comparePrefixes(a, b) {
        return a.localeCompare(b, "en", { sensitivity: "base" });
      }

      function isInRange(searchCallNum, rangeStart, rangeEnd) {
        const search = parseCallNumber(searchCallNum);
        const start = parseCallNumber(rangeStart);
        const end = parseCallNumber(rangeEnd);
        if (!search || !start || !end) return false;

        const cmpStart = comparePrefixes(search.letters, start.letters);
        const cmpEnd = comparePrefixes(search.letters, end.letters);

        if (cmpStart < 0 || cmpEnd > 0) return false;

        if (search.number !== null) {
          if (
            cmpStart === 0 &&
            start.number !== null &&
            search.number < start.number
          ) {
            return false;
          }
          if (cmpEnd === 0 && end.number !== null && search.number > end.number) {
            return false;
          }
        }

        return true;
      }

      function prepareShelfRows(rawRows) {
        state.shelves = rawRows
          .map((row) => {
            const shelfLocation = (row["Shelf Location"] || "").trim();
            const rangeRaw = (row["Call Number Range"] || "").trim();
            if (!shelfLocation || !rangeRaw) return null;
            const isReference = rangeRaw.toUpperCase() === "REF";
            const parts = !isReference ? rangeRaw.split(/\s*-\s*/) : [];
            return {
              shelfLocation,
              rangeRaw,
              startRaw: parts.length === 2 ? parts[0].trim() : null,
              endRaw: parts.length === 2 ? parts[1].trim() : null,
              isReference,
              subjects: row["Subjects / Description"] || "",
              floor: row["Floor"] || "",
            };
          })
          .filter(Boolean);
      }

      function findShelfForCallNumber(callNumber) {
        if (!callNumber) return null;
        const normalized = normalizeCallNumber(callNumber.split(/\s+/)[0]);
        if (!normalized) return null;

        for (const row of state.shelves) {
          if (row.isReference) continue;
          if (!row.startRaw || !row.endRaw) continue;
          if (isInRange(normalized, row.startRaw, row.endRaw)) {
            return row;
          }
        }
        return null;
      }

      function extractCallNumbers(availability) {
        if (!availability) return [];
        const matches = availability
          .toUpperCase()
          .match(/([A-Z]{1,4}\d{1,4}(?:\.\d+)?(?:\.[A-Z0-9]+)*)/g);
        if (!matches) return [];
        return [...new Set(matches.map((m) => m.trim()))];
      }

      function formatAvailability(raw) {
        if (!raw) return "";
        const tokens = raw
          .split("|")
          .map((token) => token.trim())
          .filter(Boolean);
        return tokens.join(" · ");
      }

      function renderCallChip(callNumber) {
        const match = findShelfForCallNumber(callNumber);
        const shelfText = match
          ? `<span class="location-tag"><i class="fas fa-layer-group"></i> Shelf ${match.shelfLocation}</span>`
          : `<span class="location-tag"><i class="fas fa-circle-question"></i> Shelf not mapped yet</span>`;
        const floorText = match && match.floor
          ? `<span class="location-tag"><i class="fas fa-building"></i> ${match.floor} Floor</span>`
          : "";
        const subjectText = match && match.subjects
          ? `<div class="subjects">${match.subjects}</div>`
          : "";

        return `
          <div class="call-chip">
            <strong>${callNumber}</strong>
            <div class="call-chip-meta">
              ${shelfText}
              ${floorText}
            </div>
            ${subjectText}
          </div>`;
      }

      function renderBookCard(book) {
        const callNumbers = extractCallNumbers(book.availability);
        const availability = formatAvailability(book.availability);
        const chips = callNumbers.length
          ? callNumbers.map((cn) => renderCallChip(cn)).join("")
          : '<div class="info-text">No call number detected in this record.</div>';
        const authors = book.authors && book.authors !== "N/A" ? book.authors : "Unknown";
        const material = book.material_info
          ? book.material_info.replace(/Material type:?/i, "").trim()
          : "";
        const publication = book.publication ? book.publication.trim() : "";

        return `
          <div class="result-card">
            <h3>
              ${
                book.detail_url
                  ? `<a href="${book.detail_url}" target="_blank" rel="noopener">${book.title || "Untitled"}</a>`
                  : `${book.title || "Untitled"}`
              }
            </h3>
            <div class="book-meta">
              <span><i class="fas fa-user-pen"></i> ${authors}</span>
              ${material ? `<span><i class="fas fa-book-open"></i> ${material}</span>` : ""}
              ${publication ? `<span><i class="fas fa-calendar-day"></i> ${publication}</span>` : ""}
              ${book.biblionumber ? `<span><i class="fas fa-hashtag"></i> ID ${book.biblionumber}</span>` : ""}
            </div>
            <div class="call-list">
              ${chips}
            </div>
            ${availability ? `<p class="info-text"></p>` : ""}
          </div>`;
      }

      function displayResults(list, totalMatches) {
        if (!list.length) {
          els.results.innerHTML = `
            <div class="no-results">
              No matches yet. Try a different spelling or search for another author/title.
            </div>`;
          els.summary.textContent = "";
          return;
        }

        const cards = list.map((book) => renderBookCard(book)).join("\n");
        const summaryText = totalMatches > MAX_RESULTS
          ? `Showing first ${MAX_RESULTS} of ${totalMatches.toLocaleString()} matches. Refine your search for more precise results.`
          : `Found ${totalMatches.toLocaleString()} matching records.`;
        els.results.innerHTML = cards;
        els.summary.textContent = summaryText;
      }

      function performSearch() {
        const query = els.search.value.trim();
        if (!query) {
          els.results.innerHTML = `
            <div class="no-results">
              Start typing a book title or author to see matching records.
            </div>`;
          els.summary.textContent = "";
          return;
        }

        if (state.booksLoading || state.shelvesLoading) {
          els.results.innerHTML = `
            <div class="no-results">Still loading data. Please hold on...</div>`;
          els.summary.textContent = "";
          return;
        }

        const tokens = query.toLowerCase().split(/\s+/).filter(Boolean);
        if (!tokens.length) {
          els.results.innerHTML = "";
          els.summary.textContent = "";
          return;
        }

        let totalMatches = 0;
        const limited = [];

        for (const book of state.books) {
          const haystack = book.searchText;
          const matches = tokens.every((token) => haystack.includes(token));
          if (!matches) continue;
          totalMatches += 1;
          if (limited.length < MAX_RESULTS) {
            limited.push(book);
          }
        }

        displayResults(limited, totalMatches);
      }

      function scheduleSearch() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(performSearch, DEBOUNCE_MS);
      }

      function loadShelves() {
        state.shelvesLoading = true;
        state.shelvesError = null;
        updateStatus();
        Papa.parse("Library_shelfs.csv", {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            prepareShelfRows(results.data);
            state.shelvesLoading = false;
            updateStatus();
            performSearch();
          },
          error: function (error) {
            state.shelvesLoading = false;
            state.shelvesError = `Shelf data error: ${error.message}`;
            updateStatus();
          },
        });
      }

      function loadBooks() {
        state.booksLoading = true;
        state.booksError = null;
        updateStatus();
        fetch("nsu_library_books_complete.json")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            state.books = data.map((book) => ({
              ...book,
              searchText: `${book.title || ""} ${book.authors || ""}`
                .toLowerCase()
                .trim(),
            }));
            state.booksLoading = false;
            updateStatus();
            performSearch();
          })
          .catch((error) => {
            state.booksLoading = false;
            state.booksError = `Book data error: ${error.message}`;
            updateStatus();
          });
      }

      // bootstrap
      els.results.innerHTML = `
        <div class="no-results">Preparing library dataset. This can take a few seconds…</div>`;
      els.summary.textContent = "";
      els.search.addEventListener("input", scheduleSearch);
      loadShelves();
      loadBooks();
    </script>
    <footer class="footer">
      <p>
        © 2025 RDS2 BUT FROM FUTURE · Created by Tahshan Jamil Shadhin
        <br />
      </p>
      <div class="social-links">
        <span>Follow me on</span>
        <a
          href="https://www.facebook.com/share/19DGPCk2wr/"
          target="_blank"
          title="Facebook"
        >
          <i class="fab fa-facebook"></i>
        </a>
        <a
          href="https://www.instagram.com/_shadhin_f"
          target="_blank"
          title="Instagram"
        >
          <i class="fab fa-instagram"></i>
        </a>
        <a
          href="https://www.linkedin.com/in/tahshan-jamil-shadhin?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app"
          target="_blank"
          title="LinkedIn"
        >
          <i class="fab fa-linkedin"></i>
        </a>
      </div>
      <br />
      Last updated: 02-01-2026
    </footer>
    <script src="script.js"></script>
    <script src="buttons.js"></script>
  </body>
</html>
