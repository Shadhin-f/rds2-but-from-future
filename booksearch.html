<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5572277246422121"
      crossorigin="anonymous"
    ></script>
    <meta name="google-adsense-account" content="ca-pub-5572277246422121" />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-DR0D2D6C35"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-DR0D2D6C35");
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/index.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NSU Library Book Finder</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .search-panel {
        margin: 1.5rem 0 1rem;
      }
      .search-panel label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--text-muted);
      }
      .search-panel input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        padding: 14px 48px 14px 14px;
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-color);
        font-size: 1.05rem;
        transition: all 0.3s ease;
      }
      .search-panel input[type="text"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.2);
      }
      .search-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      @media (max-width: 640px) {
        .search-row {
          grid-template-columns: 1fr;
        }
      }
      .search-group {
        display: flex;
        flex-direction: column;
      }
      .search-group label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      .search-group label i {
        font-size: 0.9rem;
        color: var(--primary-color);
      }
      .search-panel .search-icon {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-top: 0.4rem;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }
      #message {
        min-height: 48px;
        margin: 1rem 0;
        display: flex;
        align-items: center;
      }
      .results {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        margin-bottom: 1rem;
      }
      .result-card {
        box-sizing: border-box;
        background: linear-gradient(135deg, 
          rgba(30, 41, 59, 0.85) 0%, 
          rgba(51, 65, 85, 0.65) 50%,
          rgba(30, 41, 59, 0.75) 100%);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        padding: 20px;
        border: 1px solid rgba(139, 92, 246, 0.2);
        box-shadow: 
          0 0 0 1px rgba(255, 255, 255, 0.05) inset,
          0 -2px 12px rgba(139, 92, 246, 0.08) inset;
        overflow: hidden;
        position: relative;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
          rgba(168, 85, 247, 0.8), 
          rgba(6, 182, 212, 0.8), 
          rgba(236, 72, 153, 0.6));
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .result-card:hover::before {
        opacity: 1;
      }
      .result-card:hover {
        background: linear-gradient(135deg, 
          rgba(50, 61, 79, 0.9) 0%, 
          rgba(71, 85, 105, 0.7) 50%,
          rgba(50, 61, 79, 0.85) 100%);
        border-color: rgba(139, 92, 246, 0.4);
        box-shadow: 
          0 0 20px rgba(139, 92, 246, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        z-index: 2;
      }
      /* Medium screens: 2 columns */
      @media (max-width: 900px) {
        .results {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      /* Small screens: 1 column */
      @media (max-width: 600px) {
        .results {
          grid-template-columns: 1fr;
        }
      }
      .result-card + .result-card {
        margin-top: 0;
      }
      .result-card h3 {
        margin: 0 0 0.5rem;
        font-size: 1.15rem;
        font-weight: 600;
        line-height: 1.4;
      }
      .result-card h3 a {
        color: var(--text-color);
        text-decoration: none;
        transition: all 0.25s ease;
        display: inline;
      }
      .result-card h3 a:hover {
        background: linear-gradient(90deg, #a78bfa, #06b6d4);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }
      .book-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.6rem;
      }
      .call-list {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.5rem;
      }
      .call-chip {
        background: linear-gradient(135deg, 
          rgba(139, 92, 246, 0.1) 0%, 
          rgba(51, 65, 85, 0.4) 100%);
        border: 1px solid rgba(139, 92, 246, 0.25);
        border-radius: 14px;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        transition: all 0.25s ease;
      }
      .call-chip:hover {
        background: linear-gradient(135deg, 
          rgba(139, 92, 246, 0.15) 0%, 
          rgba(6, 182, 212, 0.1) 100%);
        border-color: rgba(139, 92, 246, 0.35);
      }
      .call-chip .subjects {
        margin-top: 0.2rem;
        font-size: 0.85rem;
      }
      .call-chip strong {
        font-family: "Courier New", monospace;
        letter-spacing: 0.05em;
        color: #a78bfa;
        font-size: 0.95rem;
      }
      .call-chip-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .location-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: rgba(51, 65, 85, 0.6);
        border: 1px solid rgba(71, 85, 105, 0.5);
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 0.82rem;
        font-weight: 500;
        transition: all 0.25s ease;
      }
      .location-tag:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(6, 182, 212, 0.4));
        border-color: rgba(139, 92, 246, 0.5);
        transform: translateY(-1px);
      }
      .subjects {
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .info-text {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-top: 0;
        margin-bottom: 1rem;
        line-height: 1.5;
      }
      .highlight {
        background: #fde047;
        color: #1e293b;
        padding: 1px 4px;
        border-radius: 4px;
        font-weight: 600;
      }
      .results-summary {
        margin-top: 0.25rem;
        margin-bottom: 1.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .no-results {
        text-align: center;
        color: var(--text-muted);
        font-size: 1rem;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .status-pill.loading {
        background: rgba(99, 102, 241, 0.12);
        border: 1px solid rgba(99, 102, 241, 0.35);
        color: var(--primary-color);
      }
      .status-pill.error {
        background: rgba(248, 113, 113, 0.15);
        border: 1px solid rgba(248, 113, 113, 0.35);
        color: #f87171;
      }
      .status-pill.success {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.35);
        color: #34d399;
      }
      .title-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.35rem;
      }
      .title-row h3 {
        margin: 0;
      }
      .check-availability-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 6px 14px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #fff;
        background: var(--primary-gradient, linear-gradient(135deg, #6d28d9, #8b5cf6));
        border: none;
        border-radius: 999px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(109, 40, 217, 0.3);
      }
      .check-availability-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(109, 40, 217, 0.45);
        filter: brightness(1.1);
      }
      .check-availability-btn:active {
        transform: translateY(0);
      }
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
      }
      .pagination-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 10px 18px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-color);
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .pagination-btn:hover:not(:disabled) {
        border-color: var(--primary-color);
        background: rgba(109, 40, 217, 0.1);
      }
      .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .pagination-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .page-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 36px;
        padding: 0 8px;
        background: var(--primary-gradient, linear-gradient(135deg, #6d28d9, #8b5cf6));
        color: #fff;
        font-weight: 600;
        border-radius: 8px;
      }
      .page-jump {
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      .page-jump input {
        width: 60px;
        padding: 8px 10px;
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 0.9rem;
        text-align: center;
      }
      .page-jump input:focus {
        outline: none;
        border-color: var(--primary-color);
      }
      .page-jump-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .page-jump-btn:hover {
        border-color: var(--primary-color);
      }
      .per-page-select {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .per-page-select select {
        padding: 6px 10px;
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        font-size: 0.85rem;
        cursor: pointer;
      }
      .per-page-select select:focus {
        outline: none;
        border-color: var(--primary-color);
      }
    </style>
  </head>
  <body>
    <canvas id="particleCanvas"></canvas>
    <div class="container">
      <header>
        <h1>Where is my book?</h1>
        <nav class="nav-bar">
          <a href="index.html">RDS2</a>
          <a href="calendar.html">Academic Calendar</a>
          <a href="resources.html" class="trending-link">Study Materials</a>
          <a href="routine.html">Routine Maker</a>
          <a href="planner.html">Semester Planner</a>
          <a href="freshman.html">Freshman Guides</a>
          <a href="coursemap.html">Course map</a>
          <a href="booksearch.html" class="active">NSU Library Book Locator</a>
          <a href="shelf_search.html">Shelf Finder</a>
          <a href="cgpa.html">CGPA Calculator</a>
          <a href="retake.html">Retake Calculator</a>
          <a href="gradeCalculator.html">Course Grade Calculator</a>
          <a href="about.html">About Dev</a>
        </nav>
      </header>

      <div class="announcement-bar">
        <span
          >Easily Search and locate books from the NSU Library</span
        >
      </div>

      <div class="search-panel">
        <div class="search-row">
          <div class="search-group">
            <label for="bookQuery"><i class="fas fa-search"></i> Search by title or author</label>
            <input
              type="text"
              id="bookQuery"
              placeholder="e.g., Game Theory, Kieso, Marketing"
              autocomplete="off"
            />
          </div>
          <div class="search-group">
            <label for="authorFilter"><i class="fas fa-user-pen"></i> Filter by author</label>
            <input
              type="text"
              id="authorFilter"
              placeholder="e.g., Kotler, Weygandt, Mankiw"
              autocomplete="off"
            />
          </div>
        </div>
      </div>
      <p class="info-text">
        Tip: Copy the exact spelling from the NSU OPAC for best matches. We
        show shelf directions for every call number we can map.
      </p>

      <div id="message"></div>
      <div id="results" class="results"></div>
      <div id="pagination" class="pagination"></div>
      <div id="resultsSummary" class="results-summary"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
      const DEBOUNCE_MS = 280;
      const DEFAULT_PER_PAGE = 15;

      const state = {
        shelves: [],
        books: [],
        shelvesLoading: false,
        booksLoading: false,
        shelvesError: null,
        booksError: null,
        filteredBooks: [],
        currentPage: 1,
        perPage: DEFAULT_PER_PAGE,
      };

      const els = {
        message: document.getElementById("message"),
        results: document.getElementById("results"),
        summary: document.getElementById("resultsSummary"),
        pagination: document.getElementById("pagination"),
        search: document.getElementById("bookQuery"),
        authorFilter: document.getElementById("authorFilter"),
      };

      let debounceTimer = null;

      function updateStatus() {
        if (state.shelvesError || state.booksError) {
          const text = [state.shelvesError, state.booksError]
            .filter(Boolean)
            .join(" · ");
          els.message.innerHTML = `
            <div class="status-pill error">
              <i class="fas fa-triangle-exclamation"></i> ${text}
            </div>`;
          return;
        }

        if (state.shelvesLoading || state.booksLoading) {
          const waitingFor = [];
          if (state.booksLoading) waitingFor.push("books");
          if (state.shelvesLoading) waitingFor.push("shelf map");
          els.message.innerHTML = `
            <div class="status-pill loading">
              <i class="fas fa-spinner fa-spin"></i>
              Loading ${waitingFor.join(" & ")} data...
            </div>`;
          return;
        }

        els.message.innerHTML = `
          <div class="status-pill success">
            <i class="fas fa-circle-check"></i>
            Loaded ${state.books.length.toLocaleString()} books · ${state.shelves.length} shelf rows
          </div>`;
      }

      function normalizeCallNumber(callNum) {
        if (!callNum) return "";
        return callNum
          .toString()
          .toUpperCase()
          .replace(/\s+/g, "")
          .replace(/[,:;.]+$/, "")
          .trim();
      }

      function parseCallNumber(callNum) {
        if (!callNum) return null;
        const s = normalizeCallNumber(callNum);
        const match = s.match(/^([A-Z]+)(\d+(?:\.\d+)?)?/);
        if (!match) return null;
        return {
          letters: match[1],
          number: match[2] !== undefined ? parseFloat(match[2]) : null,
          original: s,
        };
      }

      function comparePrefixes(a, b) {
        return a.localeCompare(b, "en", { sensitivity: "base" });
      }

      function isInRange(searchCallNum, rangeStart, rangeEnd) {
        const search = parseCallNumber(searchCallNum);
        const start = parseCallNumber(rangeStart);
        const end = parseCallNumber(rangeEnd);
        if (!search || !start || !end) return false;

        const cmpStart = comparePrefixes(search.letters, start.letters);
        const cmpEnd = comparePrefixes(search.letters, end.letters);

        if (cmpStart < 0 || cmpEnd > 0) return false;

        if (search.number !== null) {
          if (
            cmpStart === 0 &&
            start.number !== null &&
            search.number < start.number
          ) {
            return false;
          }
          if (cmpEnd === 0 && end.number !== null && search.number > end.number) {
            return false;
          }
        }

        return true;
      }

      function prepareShelfRows(rawRows) {
        state.shelves = rawRows
          .map((row) => {
            const shelfLocation = (row["Shelf Location"] || "").trim();
            const rangeRaw = (row["Call Number Range"] || "").trim();
            if (!shelfLocation || !rangeRaw) return null;
            const isReference = rangeRaw.toUpperCase() === "REF";
            const parts = !isReference ? rangeRaw.split(/\s*-\s*/) : [];
            return {
              shelfLocation,
              rangeRaw,
              startRaw: parts.length === 2 ? parts[0].trim() : null,
              endRaw: parts.length === 2 ? parts[1].trim() : null,
              isReference,
              subjects: row["Subjects / Description"] || "",
              floor: row["Floor"] || "",
            };
          })
          .filter(Boolean);
      }

      function findShelfForCallNumber(callNumber) {
        if (!callNumber) return null;
        const normalized = normalizeCallNumber(callNumber.split(/\s+/)[0]);
        if (!normalized) return null;

        for (const row of state.shelves) {
          if (row.isReference) continue;
          if (!row.startRaw || !row.endRaw) continue;
          if (isInRange(normalized, row.startRaw, row.endRaw)) {
            return row;
          }
        }
        return null;
      }

      function extractCallNumbers(availability) {
        if (!availability) return [];
        const pattern = /[A-Z]{1,4}\d{1,4}(?:\s*\.\s*[A-Z0-9]+)*/g;
        const matches = availability.toUpperCase().match(pattern);
        if (!matches) return [];
        return [...new Set(matches.map((m) => normalizeCallNumber(m)))];
      }

      function formatAvailability(raw) {
        if (!raw) return "";
        const tokens = raw
          .split("|")
          .map((token) => token.trim())
          .filter(Boolean);
        return tokens.join(" · ");
      }

      function highlightText(text, searchTokens) {
        if (!text || !searchTokens || searchTokens.length === 0) return text;
        let result = text;
        searchTokens.forEach(token => {
          if (token.length < 2) return; // Skip very short tokens
          const regex = new RegExp(`(${token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
          result = result.replace(regex, '<span class="highlight">$1</span>');
        });
        return result;
      }

      function renderCallChip(callNumber) {
        const match = findShelfForCallNumber(callNumber);
        const shelfText = match
          ? `<span class="location-tag"><i class="fas fa-layer-group"></i> Shelf ${match.shelfLocation}</span>`
          : `<span class="location-tag"><i class="fas fa-circle-question"></i> Shelf not mapped yet</span>`;
        const floorText = match && match.floor
          ? `<span class="location-tag"><i class="fas fa-building"></i> ${match.floor} Floor</span>`
          : "";
        const subjectText = match && match.subjects
          ? `<div class="subjects">${match.subjects}</div>`
          : "";

        return `
          <div class="call-chip">
            <strong>${callNumber}</strong>
            <div class="call-chip-meta">
              ${shelfText}
              ${floorText}
            </div>
            ${subjectText}
          </div>`;
      }

      function renderBookCard(book) {
        // Get current search tokens for highlighting
        const query = els.search.value.trim();
        const authorQuery = els.authorFilter.value.trim();
        const searchTokens = query.toLowerCase().split(/\s+/).filter(Boolean);
        const authorTokens = authorQuery.toLowerCase().split(/\s+/).filter(Boolean);
        const allTokens = [...searchTokens, ...authorTokens];

        const callNumbers = extractCallNumbers(book.availability);
        const availability = formatAvailability(book.availability);
        const chips = callNumbers.length
          ? callNumbers.map((cn) => renderCallChip(cn)).join("")
          : '<div class="info-text">No call number detected in this record.</div>';
        
        const rawAuthors = book.authors && book.authors !== "N/A" ? book.authors : "Unknown";
        const rawTitle = book.title || "Untitled";
        
        // Highlight matching keywords
        const highlightedTitle = highlightText(rawTitle, searchTokens);
        const highlightedAuthors = highlightText(rawAuthors, allTokens);
        
        const material = book.material_info
          ? book.material_info.replace(/Material type:?/i, "").trim()
          : "";
        const publication = book.publication ? book.publication.trim() : "";

        const availabilityBtn = book.detail_url
          ? `<a href="${book.detail_url}" target="_blank" rel="noopener" class="check-availability-btn">
               <i class="fas fa-external-link-alt"></i> Check Availability
             </a>`
          : '';

        return `
          <div class="result-card">
            <div class="title-row">
              <h3>
                ${
                  book.detail_url
                    ? `<a href="${book.detail_url}" target="_blank" rel="noopener">${highlightedTitle}</a>`
                    : `${highlightedTitle}`
                }
              </h3>
              ${availabilityBtn}
            </div>
            <div class="book-meta">
              <span><i class="fas fa-user-pen"></i> ${highlightedAuthors}</span>
              ${material ? `<span><i class="fas fa-book-open"></i> ${material}</span>` : ""}
              ${publication ? `<span><i class="fas fa-calendar-day"></i> ${publication}</span>` : ""}
              ${book.biblionumber ? `<span><i class="fas fa-hashtag"></i> ID ${book.biblionumber}</span>` : ""}
            </div>
            <div class="call-list">
              ${chips}
            </div>
            ${availability ? `<p class="info-text"></p>` : ""}
          </div>`;
      }

      function displayResults() {
        const totalMatches = state.filteredBooks.length;
        
        if (!totalMatches) {
          els.results.innerHTML = `
            <div class="no-results">
              No matches yet. Try a different spelling or search for another author/title.
            </div>`;
          els.summary.textContent = "";
          els.pagination.innerHTML = "";
          return;
        }

        const totalPages = Math.ceil(totalMatches / state.perPage);
        
        // Ensure current page is valid
        if (state.currentPage > totalPages) {
          state.currentPage = totalPages;
        }
        if (state.currentPage < 1) {
          state.currentPage = 1;
        }

        const startIndex = (state.currentPage - 1) * state.perPage;
        const endIndex = Math.min(startIndex + state.perPage, totalMatches);
        const pageBooks = state.filteredBooks.slice(startIndex, endIndex);

        const cards = pageBooks.map((book) => renderBookCard(book)).join("\n");
        els.results.innerHTML = cards;
        
        // Summary text
        const summaryText = `Showing ${startIndex + 1}–${endIndex} of ${totalMatches.toLocaleString()} matching records.`;
        els.summary.textContent = summaryText;

        // Render pagination
        renderPagination(totalPages, totalMatches);
      }

      function renderPagination(totalPages, totalMatches) {
        if (totalPages <= 1) {
          els.pagination.innerHTML = "";
          return;
        }

        els.pagination.innerHTML = `
          <button class="pagination-btn" id="prevPage" ${state.currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          
          <div class="pagination-info">
            Page <span class="page-number">${state.currentPage}</span> of ${totalPages}
          </div>
          
          <button class="pagination-btn" id="nextPage" ${state.currentPage === totalPages ? 'disabled' : ''}>
            Next <i class="fas fa-chevron-right"></i>
          </button>
          
          <div class="page-jump">
            <input type="number" id="pageInput" min="1" max="${totalPages}" value="${state.currentPage}" />
            <button class="page-jump-btn" id="goToPage">Go</button>
          </div>
          
          <div class="per-page-select">
            <label for="perPageSelect">Per page:</label>
            <select id="perPageSelect">
              <option value="10" ${state.perPage === 10 ? 'selected' : ''}>10</option>
              <option value="15" ${state.perPage === 15 ? 'selected' : ''}>15</option>
              <option value="25" ${state.perPage === 25 ? 'selected' : ''}>25</option>
              <option value="50" ${state.perPage === 50 ? 'selected' : ''}>50</option>
            </select>
          </div>
        `;

        // Add event listeners
        document.getElementById('prevPage').addEventListener('click', () => {
          if (state.currentPage > 1) {
            state.currentPage--;
            displayResults();
            scrollToResults();
          }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
          if (state.currentPage < totalPages) {
            state.currentPage++;
            displayResults();
            scrollToResults();
          }
        });

        document.getElementById('goToPage').addEventListener('click', () => {
          const input = document.getElementById('pageInput');
          const page = parseInt(input.value, 10);
          if (page >= 1 && page <= totalPages) {
            state.currentPage = page;
            displayResults();
            scrollToResults();
          }
        });

        document.getElementById('pageInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const page = parseInt(e.target.value, 10);
            if (page >= 1 && page <= totalPages) {
              state.currentPage = page;
              displayResults();
              scrollToResults();
            }
          }
        });

        document.getElementById('perPageSelect').addEventListener('change', (e) => {
          state.perPage = parseInt(e.target.value, 10);
          state.currentPage = 1; // Reset to first page
          displayResults();
        });
      }

      function scrollToResults() {
        els.results.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function performSearch() {
        const query = els.search.value.trim();
        const authorQuery = els.authorFilter.value.trim();
        
        if (state.booksLoading || state.shelvesLoading) {
          els.results.innerHTML = `
            <div class="no-results">Still loading data. Please hold on...</div>`;
          els.summary.textContent = "";
          els.pagination.innerHTML = "";
          return;
        }

        const tokens = query.toLowerCase().split(/\s+/).filter(Boolean);
        const authorTokens = authorQuery.toLowerCase().split(/\s+/).filter(Boolean);
        
        // If no search query, show all books
        if (!tokens.length && !authorTokens.length) {
          state.filteredBooks = [...state.books];
          state.currentPage = 1;
          displayResults();
          return;
        }

        // Filter all matching books
        state.filteredBooks = state.books.filter((book) => {
          const haystack = book.searchText;
          const authorHaystack = (book.authors || "").toLowerCase();
          
          // Main search: matches title or author
          const mainMatch = tokens.length === 0 || tokens.every((token) => haystack.includes(token));
          
          // Author filter: matches only author field
          const authorMatch = authorTokens.length === 0 || authorTokens.every((token) => authorHaystack.includes(token));
          
          return mainMatch && authorMatch;
        });

        // Reset to page 1 on new search
        state.currentPage = 1;
        displayResults();
      }

      function scheduleSearch() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(performSearch, DEBOUNCE_MS);
      }

      function loadShelves() {
        state.shelvesLoading = true;
        state.shelvesError = null;
        updateStatus();
        Papa.parse("Library_shelfs.csv", {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            prepareShelfRows(results.data);
            state.shelvesLoading = false;
            updateStatus();
            performSearch();
          },
          error: function (error) {
            state.shelvesLoading = false;
            state.shelvesError = `Shelf data error: ${error.message}`;
            updateStatus();
          },
        });
      }

      function loadBooks() {
        state.booksLoading = true;
        state.booksError = null;
        updateStatus();
        fetch("nsu_library_books_complete.json")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            state.books = data.map((book) => ({
              ...book,
              searchText: `${book.title || ""} ${book.authors || ""}`
                .toLowerCase()
                .trim(),
            }));
            state.booksLoading = false;
            updateStatus();
            performSearch();
          })
          .catch((error) => {
            state.booksLoading = false;
            state.booksError = `Book data error: ${error.message}`;
            updateStatus();
          });
      }

      // bootstrap
      els.results.innerHTML = `
        <div class="no-results">Preparing library dataset. This can take a few seconds…</div>`;
      els.summary.textContent = "";
      els.search.addEventListener("input", scheduleSearch);
      els.authorFilter.addEventListener("input", scheduleSearch);
      loadShelves();
      loadBooks();
    </script>
    <footer class="footer">
      <p>
        © 2025 RDS2 BUT FROM FUTURE · Created by Tahshan Jamil Shadhin
        <br />
      </p>
      <div class="social-links">
        <span>Follow me on</span>
        <a
          href="https://www.facebook.com/share/19DGPCk2wr/"
          target="_blank"
          title="Facebook"
        >
          <i class="fab fa-facebook"></i>
        </a>
        <a
          href="https://www.instagram.com/_shadhin_f"
          target="_blank"
          title="Instagram"
        >
          <i class="fab fa-instagram"></i>
        </a>
        <a
          href="https://www.linkedin.com/in/tahshan-jamil-shadhin?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app"
          target="_blank"
          title="LinkedIn"
        >
          <i class="fab fa-linkedin"></i>
        </a>
      </div>
      <br />
      Last updated: 02-01-2026
    </footer>
    <script src="script.js"></script>
    <script src="buttons.js"></script>
  </body>
</html>
